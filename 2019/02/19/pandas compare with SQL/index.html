<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Kevin W build this air-castle to collect infos &amp; photos"><title>Pandas 数据整合、清洗和SQL比较 | MonoShow</title><link rel="stylesheet" type="text/css" href="../../../../css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="../../../../favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="../../../../favicon.ico"><link rel="apple-touch-icon" href="../../../../apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="../../../../apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="../../../../atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Pandas 数据整合、清洗和SQL比较</h1><a id="logo" href="../../../../.">MonoShow</a><p class="description">Monologue from Kevin_W</p></div><div id="nav-menu"><a class="current" href="../../../../."><i class="fa fa-home"> 时间线</i></a><a href="../../../../archives/"><i class="fa fa-archive"> 档案袋</i></a><a href="../../../../photo/"><i class="fa fa-camera"> Ins摄影集</i></a><a href="../../../../categories/language-learning/"><i class="fa fa-book"> 看原著了嘛</i></a><a href="../../../../categories/github-repo/"><i class="fa fa-github"> 码代码了嘛</i></a><a href="../../../../categories/paper/"><i class="fa fa-file-text"> 翻译论文了嘛</i></a><a href="../../../../about/"><i class="fa fa-user"> 自己的碎碎念</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Pandas 数据整合、清洗和SQL比较</h1><div class="post-meta">Feb 19, 2019<span> | </span><span class="category"><a href="../../../../categories/practice/">practice</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 9</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#列的修改操作"><span class="toc-number">1.</span> <span class="toc-text">列的修改操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#select-查找"><span class="toc-number">2.</span> <span class="toc-text">select 查找</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#where"><span class="toc-number">2.1.</span> <span class="toc-text">where</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#group-by"><span class="toc-number">2.2.</span> <span class="toc-text">group by</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#groupby-其它操作"><span class="toc-number">2.2.1.</span> <span class="toc-text">groupby 其它操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据透视表"><span class="toc-number">2.2.2.</span> <span class="toc-text">数据透视表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#join"><span class="toc-number">2.3.</span> <span class="toc-text">join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#union"><span class="toc-number">2.4.</span> <span class="toc-text">union</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#order-and-aggregate"><span class="toc-number">2.5.</span> <span class="toc-text">order and aggregate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据清洗"><span class="toc-number">3.</span> <span class="toc-text">数据清洗</span></a></li></ol></div></div><div class="post-content"><p>-loading…-<br>some examples of how various SQL operations would be performed using pandas<br>收集和比较pandas使用过程中和数据库类似的一些操作，方便使用pandas进行数据分析<br><a id="more"></a></p>
<ul>
<li><p>import pandas and NumPy as follows</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br></pre></td></tr></table></figure>
</li>
<li><p>attributions of DataFrame</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.dtypes  <span class="comment"># data type of columns</span></span><br><span class="line">df.index  <span class="comment"># indexes</span></span><br><span class="line">df.columns  <span class="comment"># return pandas.index</span></span><br><span class="line">df.values  <span class="comment"># return values of each row</span></span><br><span class="line">df.shape  <span class="comment"># return dimensionality of df</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="列的修改操作"><a href="#列的修改操作" class="headerlink" title="列的修改操作"></a>列的修改操作</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- add</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tip</span><br><span class="line"><span class="keyword">ADD</span> column_name <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--update</span></span><br><span class="line"><span class="keyword">UPDATE</span> tips</span><br><span class="line"><span class="keyword">SET</span> tip = tip*<span class="number">2</span></span><br><span class="line"><span class="keyword">WHERE</span> tip &lt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--delete</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">WHERE</span> tip &gt; <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--distinct 去重</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> <span class="built_in">time</span></span><br><span class="line"><span class="keyword">FROM</span> tips</span><br></pre></td></tr></table></figure>
<ul>
<li><p>添加<br><code>tip[&#39;new_col&#39;] = [value1,value2 ...]</code><br>// 直接添加列<br><code>tip.assign(new_col = func)</code><br>// 通过assign使用赋值函数添加<br><code>tip.loc[df.col==value, &#39;new_col&#39;] = &#39;new_value&#39;</code><br>// 通过索引到行单独添加</p>
</li>
<li><p>更新<br><code>tips.loc[tips[&#39;tip&#39;] &lt; 2, &#39;tip&#39;] *= 2</code><br>// 通过条件筛选出列来直接更新</p>
</li>
<li><p>删除<br><code>tips = tips.drop(tips[&#39;tip&#39;]&gt;9, axis=1)</code><br><code>tips = tips.loc[tips[&#39;tip&#39;] &lt;= 9]</code><br>Pandas可以把不需要的过滤掉而不是删除</p>
</li>
<li><p>去重<br><code>tip[tip.duplicated()]</code><br>// 查看重复的数据<br><code>tips.drop_duplicates(subset=[&#39;time&#39;], keep=&#39;last&#39;, inplace=True)</code><br>// subset 选定列<br>// keep {‘first’,’last’,False}， 保留重复元素中的第一个、最后一个，或全部删除<br>// inplace 是否在原对象基础上进行修改</p>
</li>
<li><p>排序<br><code>sort_value(&#39;col_name&#39;, ascending=True, na_position=&#39;last&#39;)</code><br><code>sort_value([&#39;col_name1&#39;, &#39;col_name2&#39;], ascending=True, na_position=&#39;last&#39;)</code><br>// ascending 设定升降序，na_position 决定 缺失值排列的位置</p>
</li>
</ul>
<p><code>sort_index(&#39;col_name&#39;)</code>可对索引进行排序</p>
<h2 id="select-查找"><a href="#select-查找" class="headerlink" title="select 查找"></a>select 查找</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">'name_1'</span>, <span class="string">'name_2'</span>, ...</span><br><span class="line"><span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<p>SELECT * = tips 不列举列名，显示所有列<br><code>tips[[&#39;name_1&#39;,&#39;name_2&#39; ...]].head(5)</code> pandas中利用列名和head()进行筛选</p>
<p><code>df.loc[1:3, [&#39;name_1,&#39;name_2&#39;,&#39;name_3&#39; ...]]</code> 基于列label，可选取特定行（根据行index）<br><code>df.iloc[1:3, [0,1,3,5,...]]</code> 基于position(行/列)的位置<br>ix 为loc与iloc的混合体，既支持label也支持position<br><code>df.at[3, &#39;name&#39;]</code> 根据指定行index及列label，快速定位DataFrame的元素；<br>iat 与at类似，不同的是根据position来定位的；</p>
<h3 id="where"><a href="#where" class="headerlink" title="where"></a>where</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">WHERE</span> <span class="built_in">time</span> = <span class="string">'Dinner'</span></span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- tips of more than $5.00 at Dinner meals</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">WHERE</span> <span class="built_in">time</span> = <span class="string">'Dinner'</span> <span class="keyword">AND</span> tip &gt; <span class="number">5.00</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- tips of more than 5 sizes or more than 45 total_bill</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">size</span> &gt;= <span class="number">5</span> <span class="keyword">OR</span> total_bill &gt; <span class="number">45</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">WHERE</span> total_bill <span class="keyword">in</span> <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">WHERE</span> total_bill <span class="keyword">not</span> <span class="keyword">in</span> <span class="number">20</span>,<span class="number">22</span>,<span class="number">24</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> frame</span><br><span class="line"><span class="keyword">WHERE</span> col2 <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> frame</span><br><span class="line"><span class="keyword">WHERE</span> col1 <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
<p><code>tips[tips[&#39;time&#39;] == &#39;Dinner&#39;].head(5)</code> 最直观的是使用布尔索引</p>
<p><code>tips[(tips[&#39;time&#39;] == &#39;Dinner&#39;) &amp; (tips[&#39;tip&#39;] &gt; 5.00)]</code><br><code>tips[(tips[&#39;size&#39;] &gt;= 5) | (tips[&#39;total_bill&#39;] &gt; 45)]</code><br><code>tips[tips[&#39;total_bill].isin([20])]</code><br><code>tips[-tips[&#39;total_bill].isin([20,22,24])]</code><br>搭配and, or, in, not关键词可用 &amp; | isin() 实现<br>查询两者之间记录可以使用<code>between(5, 40, inclusive=True)</code></p>
<p><code>frame[frame[&#39;col2&#39;].isna()/isnull()]</code><br><code>frame[frame[&#39;col1&#39;].notna()/isnull()==False]</code><br>搭配NULL, NOT NULL，Pandas中使用isna() notna() 或 isnull()==True/False实现</p>
<ul>
<li>可以使用<code>str.contains()</code>进行正则表达式匹配查询</li>
<li>可以使用pandas提供的<code>query()</code>方法完成指定条件查询<br><code>tips.query(&#39;指定条件&#39;)</code></li>
</ul>
<h3 id="group-by"><a href="#group-by" class="headerlink" title="group by"></a>group by</h3><p><code>df.groupby([&#39;group_name&#39;])[[&#39;col1, col2 ...]].max/min/mean/median/std/count/size()</code><br>// col_name作为分组变量，对之后给出的统计量进行分组</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sex, <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> sex;</span><br><span class="line"><span class="comment">-- Female 87 Male 157</span></span><br></pre></td></tr></table></figure>
<p><code>tips.groupby(&#39;sex&#39;).size()</code><br>//groupby()将数据集拆分为组，应用一些函数(通常是聚合)，然后将这些组组合在一起</p>
<p><code>ips.groupby(&#39;sex&#39;)[&#39;total_bill&#39;].count()</code><br>//可以使用count()返回特定列中的非空记录数</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">day</span>, <span class="keyword">AVG</span>(tip), <span class="keyword">COUNT</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Fri   2.734737   19</span></span><br><span class="line"><span class="comment">Sat   2.993103   87</span></span><br><span class="line"><span class="comment">Sun   3.255132   76</span></span><br><span class="line"><span class="comment">Thur  2.771452   62</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> smoker, <span class="keyword">day</span>, <span class="keyword">COUNT</span>(*), <span class="keyword">AVG</span>(tip)</span><br><span class="line"><span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> smoker, <span class="keyword">day</span>;</span><br></pre></td></tr></table></figure>
<p><code>tips.groupby(&#39;day&#39;).agg({&#39;tip&#39;: np.mean, &#39;day&#39;: np.size})</code><br>//agg()可以使用字典格式描述列，一次汇总多个统计量</p>
<p><code>tips.groupby([&#39;smoker&#39;, &#39;day&#39;]).agg({&#39;tip&#39;: [np.size, np.mean]})</code><br>//groupby()支持多条件</p>
<ul>
<li>对分组之后的数据表可以使用多重索引的方式进行索引<br><code>df[&#39;group_name&#39;][&#39;col_name&#39;]</code></li>
</ul>
<h4 id="groupby-其它操作"><a href="#groupby-其它操作" class="headerlink" title="groupby 其它操作"></a>groupby 其它操作</h4><p><code>df.groupby([&#39;tips&#39;]).groups</code>  // 查看分组对象<br><code>df.groupby([&#39;tips&#39;]).get_group(&#39;day&#39;)</code>  // 得到某一个分组<br><code>df.groupby([&#39;tips&#39;]).transform(lambda x: ...)</code> // 对分组数据进行lambda公式转换<br><code>df.groupby([&#39;tips&#39;]).filter(filter_func)</code> // 带数据过滤的分组，filter函数单独书写<br><code>for group in df.groupby([&#39;tips&#39;]):print (group)</code> // 迭代输出分组内容</p>
<h4 id="数据透视表"><a href="#数据透视表" class="headerlink" title="数据透视表"></a>数据透视表</h4><p><code>pd.pivot_table</code>函数用来探索数据集内部的关联性，可实现拆分和堆叠列；数据透视表更像是一种多维的 GroupBy 累计操作。</p>
<ol>
<li><p>拆分<br><code>pd.pivot_table(table, index=&#39;id&#39;, columns=&#39;type&#39;, values=&#39;value&#39;, fill_value=&#39;0&#39;, aggfunc=&#39;sum&#39;).reset_index()</code><br>// index 原数据中用于分组的列或键，作为新表的行<br>// columns 新数据表中变量所在的列，作为新表的列<br>// values 待拆分的列<br>// fill_value 替换缺失值<br>// aggfunc 聚合函数或函数列表</p>
</li>
<li><p>堆叠<br><code>pd.melt(table, id_vars=&#39;id&#39;, value_vars=[&#39;value1&#39;,&#39;value2&#39; ...], value_name=&#39;name&#39;, var_name=&#39;type&#39;)</code><br>// id_vars 用于标示的变量<br>// value_vars 用于堆叠的变量<br>// value_type 堆叠后变量的名称<br>// value_name 堆叠后值的名称</p>
</li>
</ol>
<h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- inner join</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> df1</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> df2</span><br><span class="line">  <span class="keyword">ON</span> df1.key = df2.key;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- left join: show all records from df1</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> df1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> df2</span><br><span class="line">  <span class="keyword">ON</span> df1.key = df2.key;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- right join: show all records from df1</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> df1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> df2</span><br><span class="line">  <span class="keyword">ON</span> df1.key = df2.key;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- full join: show all records from both tables</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> df1</span><br><span class="line"><span class="keyword">FULL</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> df2</span><br><span class="line">  <span class="keyword">ON</span> df1.key = df2.key;</span><br></pre></td></tr></table></figure>
<p>JOINs can be performed with join() or merge()<br><code>pd.merge(df1, df2, on=&#39;key&#39;)</code><br><code>pd.merge(df1, df2, on=&#39;key&#39;, how=&#39;left&#39;)</code><br><code>pd.merge(df1, df2, on=&#39;key&#39;, how=&#39;right&#39;)</code><br><code>pd.merge(df1, df2, on=&#39;key&#39;, how=&#39;outer&#39;)</code></p>
<ul>
<li>可以设置关键字匹配索引：<code>pd.merge(df1, df2.set_index(&#39;key&#39;), on=&#39;key&#39;, right_index=True)</code></li>
<li>full join 在 RDBMS(关系型数据库)里不适用</li>
</ul>
<h3 id="union"><a href="#union" class="headerlink" title="union"></a>union</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> city, <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> df1</span><br><span class="line"><span class="keyword">UNION</span> ALL</span><br><span class="line"><span class="keyword">SELECT</span> city, <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> df2;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">         city  rank</span></span><br><span class="line"><span class="comment">      Chicago     1</span></span><br><span class="line"><span class="comment">San Francisco     2</span></span><br><span class="line"><span class="comment">New York City     3</span></span><br><span class="line"><span class="comment">      Chicago     1</span></span><br><span class="line"><span class="comment">       Boston     4</span></span><br><span class="line"><span class="comment">  Los Angeles     5</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p><code>pd.concat([df1, df2])</code>  // concat()用于链接两个数据表内容<br><code>pd.concat([df1, df2], axis=1)</code> // axis=1进行横向合并<br><code>pd.concat([df1, df2]).drop_duplicates()</code>  // 可以移除重复行</p>
<h3 id="order-and-aggregate"><a href="#order-and-aggregate" class="headerlink" title="order and aggregate"></a>order and aggregate</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tips</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> tip <span class="keyword">DESC</span></span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">10</span> <span class="keyword">OFFSET</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<p><code>tips.nlargest(10 + 5, columns=&#39;tip&#39;).tail(10)</code>  // 根据tip降序排序，从最小5开始输出10个结果</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Oracle's ROW_NUMBER() analytic function</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    t.*,</span><br><span class="line">    ROW_NUMBER() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">day</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> total_bill <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn</span><br><span class="line">  <span class="keyword">FROM</span> tips t</span><br><span class="line">)</span><br><span class="line"><span class="keyword">WHERE</span> rn &lt; <span class="number">3</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">day</span>, rn;</span><br></pre></td></tr></table></figure>
<p><code>ROW_NUMBER() OVER (PARTITION BY COL1 ORDER BY COL2)</code>row_number从1开始，为每一条分组记录返回一个数字,根据COL1分组，在分组内部根据 COL2排序，而此函数计算的值就表示每组内部排序后的顺序编号（组内连续的唯一的)<br>MySQL本身不含<code>row_number()</code>函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tips.assign(rn=tips.sort_values([<span class="string">'total_bill'</span>], ascending=<span class="keyword">False</span>)</span><br><span class="line">    .groupby([<span class="string">'day'</span>])</span><br><span class="line">    .cumcount() + <span class="number">1</span>)</span><br><span class="line">    .query(<span class="string">'rn &lt; 3'</span>)</span><br><span class="line">    .sort_values([<span class="string">'day'</span>, <span class="string">'rn'</span>])</span><br></pre></td></tr></table></figure>
<p>// DataFrame.assign()整理出一个新的列<br>// sort_values([‘total_bill’], ascending=False 根据total_bill的值倒叙排序，赋值rn<br>// groupby([‘day’]) 根据day聚合<br>// query(‘rn &lt; 3’) 筛选rn&lt;3的行<br>// sort_values([‘day’, ‘rn’] 根据day和rn排序</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tips.assign(rnk=tips.groupby([<span class="string">'day'</span>])[<span class="string">'total_bill'</span>]</span><br><span class="line">    .rank(method=<span class="string">'first'</span>, ascending=<span class="keyword">False</span>))</span><br><span class="line">    .query(<span class="string">'rnk &lt; 3'</span>)</span><br><span class="line">    .sort_values([<span class="string">'day'</span>, <span class="string">'rnk'</span>])</span><br></pre></td></tr></table></figure>
<p>// 使用rank函数返回从小到大排序的下标</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    t.*,</span><br><span class="line">    <span class="keyword">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> sex <span class="keyword">ORDER</span> <span class="keyword">BY</span> tip) <span class="keyword">AS</span> rnk</span><br><span class="line">  <span class="keyword">FROM</span> tips t</span><br><span class="line">  <span class="keyword">WHERE</span> tip &lt; <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">WHERE</span> rnk &lt; <span class="number">3</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sex, rnk;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tips[tips[<span class="string">'tip'</span>] &lt; <span class="number">2</span>]</span><br><span class="line">  .assign(rnk_min=tips.groupby([<span class="string">'sex'</span>])[<span class="string">'tip'</span>]</span><br><span class="line">  .rank(method=<span class="string">'min'</span>))</span><br><span class="line">  .query(<span class="string">'rnk_min &lt; 3'</span>)</span><br><span class="line">  .sort_values([<span class="string">'sex'</span>, <span class="string">'rnk_min'</span>])</span><br></pre></td></tr></table></figure>
<h2 id="数据清洗"><a href="#数据清洗" class="headerlink" title="数据清洗"></a>数据清洗</h2><ol>
<li>使用 <code>df.drop_duplicated()</code> 去除重复的数据</li>
<li>使用 <code>df.apply(lambda col:sum(col.isnull()))</code> 计算每列缺失的数据</li>
<li>使用 <code>df.col.fillna(df.col.mean/median())</code> 填补缺失值</li>
<li>使用盖帽法，分箱法，聚类法去除噪声</li>
</ol>
<ul>
<li>盖帽法</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cap</span><span class="params">(x,quantile=[<span class="number">0.01</span>,<span class="number">0.99</span>])</span>:</span></span><br><span class="line">  <span class="comment"># 生成分位数</span></span><br><span class="line">  Q01,Q99 = x.quantile(quantile).values.tolist()</span><br><span class="line">  <span class="keyword">if</span> Q01 &gt; x.min():</span><br><span class="line">    x = x.copy()</span><br><span class="line">    x.loc(x&lt;Q01) = Q01</span><br><span class="line">  <span class="keyword">if</span> Q99 &lt; x.max():</span><br><span class="line">    x = x.copy()</span><br><span class="line">    x.loc(x&gt;Q99) = Q99</span><br><span class="line"></span><br><span class="line">new_df = df.apply(cap, quantile=[<span class="number">0.01</span>, <span class="number">0.99</span>])</span><br></pre></td></tr></table></figure>
<ul>
<li>分箱法<br>等深分箱：每个分箱中样本数量一致<br><code>df.cut(df.col, bins=df.col.quantile([0, 0.25, 0.5, 0.75, 1]))</code><br>// 利用分位数找到分割点进行4等分箱</li>
</ul>
<p>等宽分箱：每个分箱中取值范围一致<br><code>pd.cut(pd.col, 5)</code><br>// 根据列将数据分成5等分</p>
<ul>
<li>聚类法多用于多变量处理，常用的有k-means聚类</li>
</ul>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>KevinW</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/02/19/pandas compare with SQL/">https://hyqskevin.github.io/2019/02/19/pandas compare with SQL/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</li></ul></div><br><div class="tags"><a href="../../../../tags/python/">python</a><a href="../../../../tags/pandas/">pandas</a></div><div class="post-nav"><a class="pre" href="../../20/fund-flow/">fund_flow</a><a class="next" href="../../16/book-list/">book-list</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 学习分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../../../../categories/Adobe/">Adobe</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="../../../../categories/github-repo/">github-repo</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="../../../../categories/language-learning/">language-learning</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="../../../../categories/notes/">notes</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="../../../../categories/others/">others</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="../../../../categories/paper/">paper</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="../../../../categories/practice/">practice</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="../../../../categories/repo/">repo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="../../../../categories/study/">study</a><span class="category-list-count">17</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="../../../../tags/bootstrap2-0/" style="font-size: 15px;">bootstrap2.0</a> <a href="../../../../tags/others/" style="font-size: 15px;">others</a> <a href="../../../../tags/book/" style="font-size: 15px;">book</a> <a href="../../../../tags/Kaggle/" style="font-size: 15px;">Kaggle</a> <a href="../../../../tags/flask/" style="font-size: 15px;">flask</a> <a href="../../../../tags/time-series/" style="font-size: 15px;">time_series</a> <a href="../../../../tags/ensemble-learning/" style="font-size: 15px;">ensemble_learning</a> <a href="../../../../tags/bp-nn/" style="font-size: 15px;">bp_nn</a> <a href="../../../../tags/hexo/" style="font-size: 15px;">hexo</a> <a href="../../../../tags/mysql/" style="font-size: 15px;">mysql</a> <a href="../../../../tags/algorithm/" style="font-size: 15px;">algorithm</a> <a href="../../../../tags/php/" style="font-size: 15px;">php</a> <a href="../../../../tags/session/" style="font-size: 15px;">session</a> <a href="../../../../tags/cookie/" style="font-size: 15px;">cookie</a> <a href="../../../../tags/slam/" style="font-size: 15px;">slam</a> <a href="../../../../tags/Linux-device/" style="font-size: 15px;">Linux_device</a> <a href="../../../../tags/c/" style="font-size: 15px;">c++</a> <a href="../../../../tags/laravel/" style="font-size: 15px;">laravel</a> <a href="../../../../tags/machine-learning/" style="font-size: 15px;">machine_learning</a> <a href="../../../../tags/python/" style="font-size: 15px;">python</a> <a href="../../../../tags/pandas/" style="font-size: 15px;">pandas</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="../../../04/11/flask-learning2/">Flask Web 学习笔记2 -- URL与视图函数映射</a></li><li class="post-list-item"><a class="post-list-link" href="../../../04/05/ptr/">c++中的智能指针</a></li><li class="post-list-item"><a class="post-list-link" href="../../../03/31/flask-learning1/">Flask Web 学习笔记1 -- 环境</a></li><li class="post-list-item"><a class="post-list-link" href="../../../03/25/cpp-oop/">c++ 面向对象的一些特性</a></li><li class="post-list-item"><a class="post-list-link" href="../../../03/24/bintree/">二叉树的相关操作</a></li><li class="post-list-item"><a class="post-list-link" href="../../../03/24/bintree2/">基于二叉树的衍生算法</a></li><li class="post-list-item"><a class="post-list-link" href="../../../03/21/two-divide/">二分查找策略</a></li><li class="post-list-item"><a class="post-list-link" href="../../../03/21/divide/">分治和递归基础算法</a></li><li class="post-list-item"><a class="post-list-link" href="../../../03/20/cpp-stl/">cpp_stl</a></li><li class="post-list-item"><a class="post-list-link" href="../../../03/19/hashtable/">散列表基础算法</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="../../../../." rel="nofollow">MonoShow.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="../../../../js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="../../../../js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="../../../../js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="0,0,0" opacity="0.5" zindex="-2" count="50" src="//lib.baomitu.com/canvas-nest.js/2.0.3/canvas-nest.umd.js"></script><script type="text/javascript" src="../../../../js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="../../../../js/smartresize.js?v=0.0.0"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"position":"left","width":100,"height":200},"mobile":{"show":true},"log":false});</script></body></html>